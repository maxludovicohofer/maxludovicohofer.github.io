---
import Button from "./Button.astro";

interface Props {
  className?: string;
}

const { className = "" } = Astro.props;
---

<Button
  noFocus
  noRounding
  fullHeight
  className={`can-fullscreen ${className} flex items-center justify-center overflow-hidden !bg-transparent`}
  ><slot /></Button
>
<script>
  import type { LiteYTEmbed } from "lite-youtube-embed";
  import {
    activateModal,
    getAspectClass,
    getAspectRatio,
    removeFromClasses,
    switchClasses,
  } from "src/utils";

  async function setFullscreenMedia(this: HTMLButtonElement) {
    const modal = document.querySelector<HTMLDivElement>("div.modal")!;

    if (modal.childElementCount) return;

    const originalMedia = this.querySelector(
      "img, video, iframe, lite-youtube"
    ) as
      | HTMLImageElement
      | HTMLVideoElement
      | HTMLIFrameElement
      | LiteYTEmbed
      | undefined;

    if (!originalMedia) return;

    const fullscreenMedia = originalMedia.cloneNode(
      true
    ) as typeof originalMedia;

    fullscreenMedia.className = removeFromClasses(fullscreenMedia.className, [
      "size",
      "w",
      "h",
      "pointer-events",
      "object",
    ]);

    fullscreenMedia.style.maxWidth = "inherit";
    fullscreenMedia.style.maxHeight = "inherit";

    const isLYT = fullscreenMedia.tagName === "LITE-YOUTUBE";

    if (isLYT || fullscreenMedia.tagName === "IFRAME") {
      const aspect = fullscreenMedia.dataset.aspectRatio!;
      fullscreenMedia.classList.add(getAspectClass(aspect));

      const ratio = getAspectRatio(aspect);

      // Adapt to modal slot
      const observer = new ResizeObserver((entries) =>
        entries.forEach(({ target }) =>
          switchClasses(
            fullscreenMedia,
            target.clientWidth / target.clientHeight > ratio,
            ["h-screen"],
            ["w-screen"]
          )
        )
      );

      observer.observe(
        document.querySelector<HTMLDivElement>("div.modal-slot")!
      );

      const iframe = isLYT
        ? fullscreenMedia.querySelector("iframe")!
        : (fullscreenMedia as HTMLIFrameElement);

      const startTime = fullscreenMedia.dataset.currentTime;

      if (startTime) {
        iframe.src = iframe.src.replace(/start=\d+/, `start=${startTime}`);
      }

      iframe.src = iframe.src
        .replace("controls=0", "controls=1")
        .replace("disablekb=1", "disablekb=0")
        .replace("autoplay=0", "autoplay=1");

      if (isLYT) {
        // Restart stopped videos
        (await (originalMedia as LiteYTEmbed).getYTPlayer())?.playVideo();
      }
    } else {
      fullscreenMedia.classList.add("size-auto");
    }

    activateModal(fullscreenMedia);
  }

  document.addEventListener("astro:page-load", () =>
    document
      .querySelectorAll<HTMLButtonElement>("button.can-fullscreen")
      .forEach((fullImage) =>
        fullImage.addEventListener("click", setFullscreenMedia)
      )
  );

  document.addEventListener("astro:before-swap", () =>
    document
      .querySelectorAll<HTMLButtonElement>("button.can-fullscreen")
      .forEach((fullImage) =>
        fullImage.removeEventListener("click", setFullscreenMedia)
      )
  );
</script>
