---
import type { ComponentProps } from "astro/types";
import { Image } from "astro:assets";
import Button from "./Button.astro";

interface Props {
  src?: Exclude<ComponentProps<typeof Image>["src"], string>;
  alt?: string;
  className?: string;
  imageClassName?: string;
  loading?: ComponentProps<typeof Image>["loading"];
}

const { src, alt, className = "", imageClassName = "", loading } = Astro.props;
---

{
  src && (
    <Button
      noFocus
      fullHeight
      className={`can-fullscreen ${className} !bg-transparent`}
    >
      <Image src={src} class={imageClassName} alt={alt} loading={loading} />
    </Button>
  )
}
<script>
  const activateModal = (content: Node) => {
    const modalSlot = document.querySelector<HTMLDivElement>("div.modal-slot")!;

    modalSlot.className = `${modalSlot.className} !pointer-events-auto`;

    const backdrop = modalSlot.firstElementChild!;
    backdrop.className = `${backdrop.className} !opacity-100`;

    const backButton = modalSlot.lastElementChild!;
    backButton.className = `${backButton.className} !opacity-100`;

    const modal = backButton.previousElementSibling!.firstElementChild!;
    modal.append(content);
  };

  document.addEventListener("astro:page-load", () =>
    document
      .querySelectorAll<HTMLButtonElement>("button.can-fullscreen")
      ?.forEach((fullImage) =>
        fullImage.addEventListener("click", () => {
          const modalImage = fullImage.cloneNode(true) as HTMLElement;

          modalImage.className = `${modalImage.className} !visible !opacity-100 hover:!scale-100 active:!scale-100 !w-full !max-w-none !h-full !max-h-none !relative !inset-0 !m-0 flex flex-col items-center justify-center`;

          const image = modalImage.firstElementChild as HTMLImageElement;

          const imageAspect = image.width / image.height;
          const screenAspect = screen.width / screen.height;

          image.className = `${image.className} !object-cover !max-h-[90vh] lg:!max-h-[80vh] !max-w-[90vw] lg:!max-w-[80vw] rounded-3xl ${imageAspect > screenAspect ? "!h-auto !w-screen" : "!h-screen !w-auto"} `;

          activateModal(modalImage);
        })
      )
  );
</script>
