---
import Page from "@layouts/Page.astro";
import Bento from "@layouts/Bento.astro";
import Profile from "@components/index/Profile.astro";
import AllProjects from "@components/index/AllProjects.astro";
import AllThoughts from "@components/index/AllThoughts.astro";
import { getEntry } from "astro:content";
import Video from "@layouts/Video.astro";
import PostPreview from "@layouts/PostPreview.astro";
import TechPreview from "@components/index/TechPreview.astro";
import { getCollection } from "astro:content";
import { getLastModifiedDate } from "@layouts/Post.astro";
import dayjs from "dayjs";
import minMax from "dayjs/plugin/minMax";
import type { CollectionKey } from "astro:content";

export const highlightThought = await getEntry("thoughts", "style");
export const highlightProject = await getEntry(
  "projects",
  "steelsilk-championship"
);

export const getLatestEntry = async <C extends CollectionKey>(
  collection: C
) => {
  const entries = await getCollection(
    collection,
    ({ data: { draft }, id }) =>
      !draft && id !== highlightThought.id && id !== highlightProject.id
  );

  const collectionDates = await Promise.all(
    entries.map(
      async ({ render }) =>
        getLastModifiedDate((await render()).remarkPluginFrontmatter)!
    )
  );

  dayjs.extend(minMax);

  return entries.length
    ? entries[collectionDates.indexOf(dayjs.min(collectionDates)!)]
    : undefined;
};

export const latestThought = await getLatestEntry("thoughts");
export const latestProject = await getLatestEntry("projects");
---

<Page
  title="Game Designer"
  description="Max Hofer's game design portfolio and blog."
>
  <Bento>
    <Profile slot="1-medium" importance={1} />
    <Video
      slot="2-small"
      title="Showreel"
      youtubeID="m0KhK_J0LiQ"
      className="!aspect-[16/10]"
    />
    <PostPreview slot="3-small" entry={highlightThought} hideDate />
    <PostPreview
      slot="4-large"
      entry={highlightProject}
      importance={3}
      hideDate
    />
    <PostPreview slot="5-small" entry={latestThought} />
    <PostPreview slot="6-medium" entry={latestProject} importance={3} />
    <TechPreview slot="7-small" importance={1} />
    <AllProjects slot="8-large" />
    <AllThoughts slot="9-medium" />
  </Bento>
</Page>
