---
import { getStaticPaths as getBasePaths } from "@pages/index.astro";
import DocumentPage from "@layouts/document/DocumentPage.astro";
import { i18n, setLocale } from "@integrations/i18n-server";
import dayjs from "dayjs";
import duration from "dayjs/plugin/duration";
import { getSummary } from "@integrations/docs";
import {
  getCategory,
  getKnowHow,
  getDevelopmentTime,
  getTeam,
} from "@integrations/content";
import Link from "@components/ui/Link.astro";
import {
  getMatchedPosts,
  getSiteLink,
  matchRoles,
} from "@integrations/astro-server";
import { applyMatch } from "@integrations/astro-server";
import { getEntryId } from "@layouts/document/Document.astro";
import ShokumuEntry from "@components/docs/ShokumuEntry.astro";
import { getTech } from "@components/TechList.astro";

export const getStaticPaths = () => getBasePaths({ allowedLocales: ["ja"] });

await setLocale(Astro);
dayjs.extend(duration);

const today = dayjs();

const t = i18n(Astro);

const name = await t("Hofer Max Ludovico");
const summary = await t(await getSummary(Astro));

const { experience } = await getKnowHow(Astro);

const portfolioSentence = await t("Portfolio");
const portfolioLink = await getSiteLink(Astro);

// Number from 0-10 that filters out weak matches
const projectMatchThreshold = 1;
const durationThreshold = dayjs.duration({ days: 4 });

const experienceTechThreshold = 1;

// TODO WRITE SELF PR
// TODO CHECK EDGE FAVORITES FOR HOW TO WRITE THE TWO RESUMES
---

<DocumentPage pageProps={{ noTranslation: true }}>
  <h1 class="!text-2xl text-center">è·å‹™çµŒæ­´æ›¸</h1>
  <div class="text-right mt-6">
    {today.format("ll")}
    <br />
    {name}ï¼ˆæ°åï¼‰
  </div>
  <h2>â– è·å‹™è¦ç´„</h2>
  <p>
    {summary}
    <br />
    <br />
    {portfolioSentence} ğŸ¡¢ <Link href={portfolioLink} />
  </p>
  <h2>â– è·å‹™çµŒæ­´è©³ç´°</h2>
  {
    experience &&
      Object.values(experience).map(
        async ({
          id,
          translateId,
          start,
          end,
          skill: { job, achievements, countAsWork },
          projects,
          tech,
          team,
        }) => {
          const organization = `${translateId ? await t(id) : id}${countAsWork ? `${await t("(")}${await t("school")}${await t(")")}` : ""}`;

          const matchedProjects =
            projects &&
            (await getMatchedPosts(Astro, "projects", {
              entries: projects.map(({ id, ...project }) => ({
                // Fixes project IDs
                id: `${id}/${id}`,
                ...project,
              })),
            }));
          const relevantProjects =
            matchedProjects &&
            applyMatch(matchedProjects, projectMatchThreshold)
              .filter(
                (project) => getDevelopmentTime(project)! > durationThreshold
              )
              .slice(0, 3)
              .sort((a, b) =>
                b.publishingDate.isAfter(a.publishingDate) ? 1 : -1
              );

          const experienceTech =
            tech &&
            (await getTech(Astro, experienceTechThreshold, {
              entries: tech,
            }));

          return (
            <>
              <h3>{organization}</h3>
              <table>
                <thead>
                  <tr>
                    <th class="text-center w-56">ç¯„å›²</th>
                    <th class="text-center min-w-96">æ¥­å‹™å†…å®¹</th>
                    <th class="text-center w-56">ç’°å¢ƒ</th>
                  </tr>
                </thead>
                <tbody>
                  {relevantProjects?.length ? (
                    relevantProjects.map(async (project) => {
                      const {
                        collection,
                        id,
                        publishingDate,
                        data: { roles, tech, awards },
                      } = project;

                      const projectRoles = applyMatch(
                        await matchRoles(
                          Astro,
                          roles.map((roleInfo) => ({
                            data: roleInfo,
                            roles: [roleInfo.role],
                          }))
                        )
                      );

                      const projectTech = await getTech(Astro, undefined, {
                        entries: tech,
                      });

                      return (
                        <ShokumuEntry
                          start={publishingDate.subtract(
                            //! Dayjs has issue with weeks at the moment, so must transform in ms
                            getDevelopmentTime(project)!.asMilliseconds()
                          )}
                          end={publishingDate}
                          roles={projectRoles.map(({ role }) => role)}
                          points={[
                            ...(awards?.map((award) => `Won ${award}`) ?? []),
                            ...projectRoles.flatMap(
                              ({ achievements }) => achievements
                            ),
                          ]}
                          link={await getSiteLink(
                            Astro,
                            `${collection}/${getEntryId(id)}`
                          )}
                          tech={projectTech}
                          projectType={getCategory(project)}
                          team={getTeam(project)!}
                        />
                      );
                    })
                  ) : (
                    <ShokumuEntry
                      start={start}
                      end={end}
                      roles={[job]}
                      points={achievements}
                      tech={experienceTech!}
                      team={team!}
                    />
                  )}
                </tbody>
              </table>
            </>
          );
        }
      )
  }
  <h2>â– è‡ªå·±PR</h2>
  <p>
    ç›®æ¨™å®Ÿç¾ã‚’æ„è­˜ã—ãŸã‚µã‚¤ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¿ƒãŒã‘ã€ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ã¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨åˆ¶ä½œã‚¹ã‚¿ãƒƒãƒ•ã®è¦
    æœ›ã®èª¿æ•´ã‚’è¡Œã£ã¦ã¾ã„ã‚Šã¾ã—ãŸã€‚å¸¸ã«ç›®æ¨™ã¨èªè­˜ã®ç¢ºèªã‚’è¡Œã„ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ãŒæœ€æ–°æƒ…å ±
    ã¨å½“äº‹è€…æ„è­˜ã‚’æŒã¡ã€ä¸€ä¸¸ã¨ãªã£ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é€²è¡Œã•ã›ã‚‹ã“ã¨ã‚’å¿ƒãŒã‘ã¾ã—ãŸã€‚ãã®çµæœã€æ‹…å½“ãƒ—
    ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®æ¨™ã¯ã™ã¹ã¦é”æˆã—ã€ç´æœŸã‚‚é…ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
    ä»Šå¾Œã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãƒ¡ãƒ³ãƒãƒ¼åŒæ–¹ãŒæº€è¶³ã§ãã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†è€…ã‚’ç›®æŒ‡ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
  </p>
  <p class="text-right">ä»¥ä¸Š</p>
</DocumentPage>
