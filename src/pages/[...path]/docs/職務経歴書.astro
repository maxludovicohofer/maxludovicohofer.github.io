---
import { getStaticPaths as getBasePaths } from "@pages/index.astro";
import DocumentPage from "@layouts/document/DocumentPage.astro";
import { i18n, setLocale } from "@integrations/i18n-server";
import dayjs from "dayjs";
import duration from "dayjs/plugin/duration";
import { getSummary } from "@integrations/docs";
import Text from "@components/ui/Text.astro";
import {
  getCategory,
  getKnowHow,
  getPublishingDate,
  getDevelopmentTime,
  getTeam,
} from "@integrations/content";
import { getFormattedDates } from "@components/docs/ResumeKnowHow.astro";
import Link from "@components/ui/Link.astro";
import {
  getMatchedPosts,
  getSiteLink,
  matchRoles,
} from "@integrations/astro-server";
import { applyMatch } from "@integrations/astro-server";
import { capitalize, toTextList } from "@integrations/text";
import { getEntryId } from "@layouts/document/Document.astro";
import { getTech } from "@components/TechList.astro";

export const getStaticPaths = () => getBasePaths({ allowedLocales: ["ja"] });

await setLocale(Astro);
dayjs.extend(duration);

const today = dayjs();

const t = i18n(Astro);

const name = await t("Hofer Max Ludovico");
const summary = await getSummary(Astro);

const { experience } = await getKnowHow(Astro);

const portfolioSentence = await t("Portfolio");
const portfolioLink = await getSiteLink(Astro);

// Number from 0-10 that filters out weak matches
const matchThreshold = 1;
const durationThreshold = dayjs.duration({ days: 4 });

const experienceTechThreshold = 0;

// TODO WRITE SELF PR
---

<DocumentPage pageProps={{ noTranslation: true }}>
  <h1 class="!text-2xl text-center">è·å‹™çµŒæ­´æ›¸</h1>
  <div class="text-right mt-6">
    {today.format("ll")}
    <br />
    {name}ï¼ˆæ°åï¼‰
  </div>
  <h2>â– è·å‹™è¦ç´„</h2>
  <Text>{summary}</Text>
  {portfolioSentence} ğŸ¡¢ <Link href={portfolioLink} />
  <h2>â– è·å‹™çµŒæ­´è©³ç´°</h2>
  {
    experience &&
      Object.values(experience).map(
        async ({
          id,
          translateId,
          start,
          end,
          skill: { job, achievements, countAsWork },
          projects,
          tech,
          team,
        }) => {
          const organization = `${translateId ? await t(id) : id}${countAsWork ? `${await t("(")}${await t("school")}${await t(")")}` : ""}`;
          const dates = await getFormattedDates(Astro, start, end);
          const translatedJob = await t(job.id);
          const matchedProjects =
            projects &&
            (await getMatchedPosts(Astro, "projects", {
              entries: projects.map(({ id, ...project }) => ({
                // Fixes project IDs
                id: `${id}/${id}`,
                ...project,
              })),
            }));
          const projectData =
            matchedProjects &&
            applyMatch(matchedProjects, matchThreshold).filter(
              (project) => getDevelopmentTime(project)! > durationThreshold
            );

          const experienceTechIds = tech?.map(({ id }) => id);
          const experienceTechToDisplay = experienceTechIds
            ? (await getTech(Astro, experienceTechThreshold)).filter(({ id }) =>
                experienceTechIds.includes(id)
              )
            : [];

          const soloExperience =
            !team || (team.internal === 1 && !team.external);
          const experienceScaleText = soloExperience
            ? await t("Solo")
            : `${team.internal}å${team.external ? `ï¼ˆã†ã¡å¤–æ³¨ã‚¹ã‚¿ãƒƒãƒ•${team.external}åï¼‰` : ""}`;

          return (
            <>
              <h3>{organization}</h3>
              <table>
                <thead>
                  <tr>
                    <th class="text-center">æœŸé–“</th>
                    <th class="text-center">æ¥­å‹™å†…å®¹</th>
                    <th class="text-center">ç’°å¢ƒ</th>
                    <th class="text-center">è¦æ¨¡</th>
                  </tr>
                </thead>
                <tbody>
                  {projectData?.length ? (
                    projectData.map(async (project) => {
                      const publishingDate = getPublishingDate(project);
                      const dates = await getFormattedDates(
                        Astro,
                        publishingDate?.subtract(getDevelopmentTime(project)!)!,
                        publishingDate
                      );

                      const category = await t(getCategory(project)!);

                      const team = getTeam(project);

                      const {
                        collection,
                        id,
                        data: { roles, tech, awards },
                      } = project;

                      const soloDeveloped =
                        !team || (team.internal === 1 && !team.external);
                      const scaleText = soloDeveloped
                        ? await t("Solo")
                        : `${team.internal}å${team.external ? `ï¼ˆã†ã¡å¤–æ³¨ã‚¹ã‚¿ãƒƒãƒ•${team.external}åï¼‰` : ""}`;

                      const projectLink = await getSiteLink(
                        Astro,
                        `${collection}/${getEntryId(id)}`
                      );

                      const rolesToDisplay = applyMatch(
                        await matchRoles(
                          Astro,
                          roles.map((roleInfo) => ({
                            data: roleInfo,
                            roles: [roleInfo.role],
                          }))
                        )
                      );

                      const rolesSentence = `${await t(capitalize(toTextList(rolesToDisplay.slice(0, 3).map(({ role: { id } }) => id))))}${await t(".")}`;

                      const achievementsToDisplay = [
                        ...(awards?.map((award) => `Won ${award}`) ?? []),
                        ...rolesToDisplay.flatMap(
                          ({ achievements }) => achievements
                        ),
                      ].slice(0, 2);

                      const techIds = tech.map(({ id }) => id);
                      const techToDisplay = (await getTech(Astro)).filter(
                        ({ id }) => techIds.includes(id)
                      );

                      return (
                        <tr>
                          <td>{dates.join("ï½")}</td>
                          <td>
                            [å½¹è·] {rolesSentence}
                            <br />
                            <br />
                            [ãƒã‚¤ãƒ³ãƒˆ]
                            <ul class="mt-0">
                              {achievementsToDisplay.map((achievement) => (
                                <Text tag="li">{capitalize(achievement)}.</Text>
                              ))}
                            </ul>
                            <Link href={projectLink} />
                          </td>
                          <td>
                            {techToDisplay.map(async ({ id }, index) => {
                              const translatedId = await t(id);

                              return (
                                <>
                                  {index ? <br /> : ""}
                                  {translatedId}
                                </>
                              );
                            })}
                          </td>
                          <td>
                            [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ]
                            <br />
                            {category}
                            <br />
                            <br />
                            [ãƒãƒ¼ãƒ ]
                            <br />
                            {scaleText}
                          </td>
                        </tr>
                      );
                    })
                  ) : (
                    <tr>
                      <td>{dates.join("ï½")}</td>
                      <td>
                        [æ‹…å½“æ¥­å‹™] {translatedJob}
                        <br />
                        <br />
                        [ãƒã‚¤ãƒ³ãƒˆ]
                        <ul>
                          {achievements.map((achievement) => (
                            <Text tag="li">{achievement}</Text>
                          ))}
                        </ul>
                      </td>
                      <td>
                        {experienceTechToDisplay.map(async ({ id }, index) => {
                          const translatedId = await t(id);

                          return (
                            <>
                              {index ? <br /> : ""}
                              {translatedId}
                            </>
                          );
                        })}
                      </td>
                      <td>
                        [ä¼šç¤¾]
                        <br />
                        {experienceScaleText}
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </>
          );
        }
      )
  }
  <h2>â– è‡ªå·±PR</h2>
  <p>
    ç›®æ¨™å®Ÿç¾ã‚’æ„è­˜ã—ãŸã‚µã‚¤ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¿ƒãŒã‘ã€ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ã¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨åˆ¶ä½œã‚¹ã‚¿ãƒƒãƒ•ã®è¦
    æœ›ã®èª¿æ•´ã‚’è¡Œã£ã¦ã¾ã„ã‚Šã¾ã—ãŸã€‚å¸¸ã«ç›®æ¨™ã¨èªè­˜ã®ç¢ºèªã‚’è¡Œã„ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ãŒæœ€æ–°æƒ…å ±
    ã¨å½“äº‹è€…æ„è­˜ã‚’æŒã¡ã€ä¸€ä¸¸ã¨ãªã£ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é€²è¡Œã•ã›ã‚‹ã“ã¨ã‚’å¿ƒãŒã‘ã¾ã—ãŸã€‚ãã®çµæœã€æ‹…å½“ãƒ—
    ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®æ¨™ã¯ã™ã¹ã¦é”æˆã—ã€ç´æœŸã‚‚é…ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
    ä»Šå¾Œã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãƒ¡ãƒ³ãƒãƒ¼åŒæ–¹ãŒæº€è¶³ã§ãã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†è€…ã‚’ç›®æŒ‡ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
  </p>
  <p class="text-right">ä»¥ä¸Š</p>
</DocumentPage>
