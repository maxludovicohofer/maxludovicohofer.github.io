---
import { getKnowHow } from "@integrations/content";
import Text from "@components/ui/Text.astro";
import { capitalize } from "@integrations/text";
import {
  getCurrentLocale,
  i18n,
  localeInfo,
  setLocale,
} from "@integrations/i18n-server";
import dayjs from "dayjs";
import duration from "dayjs/plugin/duration";
import type { AstroGlobal } from "astro";

const knowHow = await getKnowHow(Astro);

await setLocale(Astro);
dayjs.extend(duration);

export const getFormattedDates = async (
  astro: AstroGlobal,
  start: dayjs.Dayjs,
  end?: dayjs.Dayjs
) => {
  await setLocale(astro);
  dayjs.extend(duration);

  const today = dayjs();
  const dates = [start, end ?? today] as const;

  const dropDayDate = today.subtract(dayjs.duration({ months: 1 }));
  const showDay =
    dates[1].diff(dates[0], "month") < 1 ||
    dates.some((date) => date > dropDayDate);

  const dropMonthDate = today.subtract(dayjs.duration({ years: 5 }));
  const showMonth =
    dates[1].diff(dates[0], "year") < 1 ||
    dates.some((date) => date > dropMonthDate);

  const { getYear, getYearMonth } = localeInfo[getCurrentLocale(astro)];

  return dates.map((date) => {
    if (date === today) return "Present";

    if (showDay) return date.format("ll");

    if (showMonth) return getYearMonth(date.format("ll"));

    return getYear(date.format("LL"));
  });
};

const t = i18n(Astro);
---

{
  Object.entries(knowHow).map(([title, experiences]) => (
    <>
      <Text tag="h2">{capitalize(title)}</Text>
      <ol class="list-none ps-0">
        {experiences.map(
          async ({
            skill: { job, achievements, countAsWork },
            id,
            start,
            end,
            translateId,
            dropOut,
          }) => {
            const translatedId = translateId ? await t(id) : id;
            const comma = `${await t(",")} `;
            const dates = await getFormattedDates(Astro, start, end);

            return (
              <li class="ps-0">
                <Text tag="h3">
                  {job.id}
                  {countAsWork ? " (school)" : ""}
                  {dropOut ? " (not graduated)" : ""}
                </Text>
                <Text tag="h4" subtitle translateProps={{ disable: true }}>
                  {translatedId}
                  {comma}
                  {dates.join(" - ")}
                </Text>
                <ol class="list-disc">
                  {achievements.map((achievement) => (
                    <Text tag="li">{achievement}</Text>
                  ))}
                </ol>
              </li>
            );
          }
        )}
      </ol>
    </>
  ))
}
