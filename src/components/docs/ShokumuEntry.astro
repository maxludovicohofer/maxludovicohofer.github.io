---
import Link from "@components/ui/Link.astro";
import Text from "@components/ui/Text.astro";
import { capitalize, toTextList, endDot } from "@integrations/text";
import type dayjs from "dayjs";
import { getFormattedDates } from "./ResumeKnowHow.astro";
import { i18n } from "@integrations/i18n-server";
import type { ReferenceDataEntry } from "astro:content";
import type { ComponentProps } from "astro/types";
import type { CollectionEntry } from "astro:content";

interface Props {
  start: dayjs.Dayjs;
  end?: dayjs.Dayjs | undefined;
  roles: ReferenceDataEntry<"roles">[];
  points: string[];
  link?: ComponentProps<typeof Link>["href"] | undefined;
  tech: CollectionEntry<"tech">[];
  projectType?: string | undefined;
  team: { internal: number; external: number };
}

const { start, end, roles, points, link, tech, projectType, team } =
  Astro.props;

const t = i18n(Astro);

const dates = await getFormattedDates(Astro, start, end);
const type = projectType && (await t(projectType));
const soloDeveloped = !team || (team.internal === 1 && !team.external);
const scaleText = soloDeveloped
  ? await t("Solo")
  : `${team.internal + team.external}名${team.external ? `（うち外注スタッフ${team.external}名）` : ""}`;

const rolesSentence = `${await t(capitalize(toTextList(roles.slice(0, 3).map(({ id }) => id))))}${await t(".")}`;
const linkText = await t("Read development");
---

<tr>
  <td>
    [期間]
    <br />
    {dates.join("～")}
    <br />
    <br />
    [規模]
    <br />
    {scaleText}
    {
      type && (
        <>
          <br />
          <br />
          [プロジェクト]
          <br />
          {type}
        </>
      )
    }
  </td>
  <td>
    [役職] {rolesSentence}
    <br />
    <br />
    [ポイント]
    <ul class="mt-0 last:-mb-2">
      {
        points
          .slice(0, 3)
          .map((point) => <Text tag="li">{endDot(capitalize(point))}</Text>)
      }
    </ul>
    {
      link && (
        <div class="-mt-4 text-right">
          <Link class="!text-wrap" href={link}>
            {linkText}
          </Link>
        </div>
      )
    }
  </td>
  <td>
    <ul class="list-none ps-0 my-0">
      {
        tech.map(async ({ id }) => {
          const translatedId = await t(id);
          return <li class="my-0 ps-0">{translatedId}</li>;
        })
      }
    </ul>
  </td>
</tr>
