---
import Video from "@ui/Video.astro";
import {
  generateShowreelCaptions,
  setYouTubeCaptions,
} from "@integrations/video";
import { applyMatch, getRole, matchRoles } from "@integrations/astro-server";
import { getEntry } from "astro:content";
import { getCurrentLocale } from "@integrations/i18n-special";
import { dump } from "js-yaml";
import { locales } from "@integrations/astro-config.mts";
import { capitalize } from "@integrations/text";

const {
  id,
  data: showreels,
  filePath,
} = (await getEntry("videos", "showreel"))!;

// TODO PHASE 2 GENERATE ROLE-MATCHED SHOWREEL BASED ON PROJECTS VIDEOS

const showreel = applyMatch(
  await matchRoles(
    Astro,
    showreels.map((showreel) => ({ data: showreel, roles: [showreel.role] }))
  )
)[0]!;

if (import.meta.env.DEV) {
  const { role, isDefault } = await getRole(Astro);

  if (showreel.role.id !== role.id) {
    // TODO DUPLICATE SHOWREEL WITH ROLE TITLE IF NOT PRESENT FOR ROLE
  }

  const currentLocale = getCurrentLocale(Astro);
  const captions = await generateShowreelCaptions(Astro);

  // Update captions if non existent for current locale or different
  if (
    showreel.captions.every(
      ({ locale, text }) => locale !== currentLocale || text !== captions
    )
  ) {
    const showreelCaptions = showreels[showreels.indexOf(showreel)]!.captions;

    const existingCaption = showreelCaptions.find(
      ({ locale }) => locale === currentLocale
    );

    console.info(
      `${existingCaption ? "Updating" : "Creating"} "${capitalize(`${isDefault ? "" : `${role.id} `}${id}`)}"'s ${currentLocale} caption`
    );

    const captionId = await setYouTubeCaptions(
      Astro,
      captions,
      showreel.youTubeId,
      existingCaption?.youTubeId
    );

    if (captionId) {
      // Update cache
      if (existingCaption) {
        showreelCaptions[showreelCaptions.indexOf(existingCaption)]!.text =
          captions;
      } else {
        showreelCaptions.push({
          locale: currentLocale,
          youTubeId: captionId,
          text: captions,
        });
        showreelCaptions.sort(
          (a, b) => locales.indexOf(a.locale) - locales.indexOf(b.locale)
        );
      }

      const { writeFile } = await import("fs/promises");
      writeFile(filePath!, dump(showreels));
    }
  }
}
---

<Video
  youTubeInfo={{ id: showreel.youTubeId, aspect: "16/10" }}
  showSubtitles
/>
