---
import Card from "@layouts/Card.astro";
import { getLastModifiedDate } from "@layouts/Post.astro";
import PostPreview from "@layouts/PostPreview.astro";
import type { CollectionEntry } from "astro:content";
import type { CollectionKey } from "astro:content";
import { getCollection } from "astro:content";

interface Props {
  collection: CollectionKey;
  short?: boolean;
  className?: string;
  exclude?: CollectionEntry<CollectionKey>[] | undefined;
  additional?: CollectionEntry<CollectionKey>[];
}

const {
  collection,
  short,
  className,
  exclude = [],
  additional = [],
} = Astro.props;

export const getSortedEntries = async <C extends CollectionKey>(
  entryCollection: C,
  excluded: CollectionEntry<CollectionKey>[] = []
) => {
  // Exclude highlight and latest, will be added again at the end
  const entries = await getCollection(
    entryCollection,
    ({ data: { draft }, id }) =>
      !draft && excluded.every((entry) => id !== entry.id)
  );

  // Sort by latest first
  return (
    await Promise.all(
      entries.map(async (entry) => ({
        ...entry,
        lastModifiedDate: getLastModifiedDate(
          (await entry.render()).remarkPluginFrontmatter
        )!,
      }))
    )
  ).toSorted((a, b) =>
    b.lastModifiedDate.isAfter(a.lastModifiedDate) ? 1 : -1
  );
};

const sortedEntries: CollectionEntry<typeof collection>[] =
  await getSortedEntries(collection, exclude);

// Add additional at the end
sortedEntries.push(...additional);
---

<ol class={`grid grid-cols-1 gap-4 mb-4 ${className}`}>
  {
    sortedEntries.map((entry) => (
      <Card tag="li" className={short ? "min-h-60 max-h-72 xl:max-h-none" : ""}>
        <PostPreview
          importance={2}
          entry={entry}
          fullHeightReadMore={short}
          minutesAlreadySpentReading={short ? 0 : undefined}
          descriptionAsBody={short}
        />
      </Card>
    ))
  }
</ol>
